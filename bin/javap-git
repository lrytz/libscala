#!/usr/bin/env bash
#

JAVAP="$JAVA_HOME/bin/javap"
JAVAP_CMD="$JAVAP -c -s -private"

# printing inner classes only
inner-classes () {
  local class="$1"
  local seenInner="false"
  
  $JAVAP -verbose "$class" | tr -d 0-9 | while read line; do
    if [[ "$line" =~ version: ]]; then
      echo ""
      return;
    elif [[ "$seenInner" == "true" ]]; then
      [[ "$line" =~ \$anon ]] || echo "$line"
    elif [[ "$line" =~ InnerClass ]]; then
      echo "InnerClasses:"
      seenInner="true"
    fi    
  done
}

javap-cleaner () {
  $JAVAP_CMD "$1"  |
    perl -pe 's/^\s*\d+:/  :/g;' |
    perl -pe 's/#\d+/##/g' |
    perl -pe 's/\s+\d+\s*$//;' |
    egrep -v '[\00]'
}

javap-clean () {
  local path="$1"
  local dirname=$(dirname "$path")
  local basename=$(basename "$path")
  local class=${basename%%.class}
    
  ( cd "$dirname" && inner-classes "$class" && javap-cleaner "$class" )
}

javap-clean "$1"
