#!/bin/sh
#

# set -o errexit  # exit on errors
# 
[[ $# -eq 3 ]] || { echo "Usage: $0 <branch> <src gitdir> <dest gitdir>"; exit 1; }

unset cd

BASE=`pwd`
branch=$1
src=`abspath $2`
dest=`abspath $3`

function exists() {
  $( cd $dest ; git show-ref --verify "refs/heads/$1" &> /dev/null )
}

cd $src
succ=""
fail=""
tmp=`mktemp -d -t git-transfer`
git checkout --quiet $branch && \
  git format-patch -o $tmp -M -B -C master &> /dev/null && \
  echo "Applying patches to $branch:"
status=$?

if [[ $status -ne 0 ]]; then
  echo "git-format-patch failed for $branch."
  exit 1;
fi
  
cd "$dest" && \
  git checkout --quiet -b $branch master && \
  git am --quiet --3way $tmp/*.patch
status=$?
  
if [[ $status -eq 0 ]]; then
  succ="$succ $branch"
  git checkout --quiet master
else
  echo "$branch failed, aborting it."
  git am --abort
  git reset --hard
  git clean --quiet -f -d .
  git checkout -f --quiet master
  git branch -D $branch
fi

rm -rf "$tmp"
git checkout -f master

echo "Moved $branch from $src to $dest."
